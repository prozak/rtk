# Generated Parser Files for Self-Hosting

This directory contains parser files generated from `test-grammars/grammar.pg` for RTK's self-hosting experiment (Prototype 2).

## How to Generate These Files

### Step 1: Generate from grammar.pg

```bash
# Run from rtk root directory
cabal build
cabal run rtk -- test-grammars/grammar.pg src/generated/
```

This creates:
- `GrammarLexer.x` - Alex lexer specification
- `GrammarParser.y` - Happy parser specification
- `GrammarQQ.hs` - QuasiQuoter module

### Step 2: Compile Alex/Happy Files

```bash
cd src/generated

# Compile lexer
cabal exec alex -- GrammarLexer.x -o GrammarLexer.hs

# Compile parser
cabal exec happy -- GrammarParser.y --ghc -o GrammarParser.hs
```

This creates:
- `GrammarLexer.hs` - Compiled lexer module
- `GrammarParser.hs` - Compiled parser module

### Step 3: Build RTK with Generated Parsers

```bash
cd ../..
cabal build
```

The generated modules will be compiled into the RTK executable.

### Step 4: Test

```bash
# Test hand-written parser (default)
cabal run rtk -- test-grammars/grammar.pg test-out/hand

# Test generated parser (experimental)
cabal run rtk -- --use-generated test-grammars/grammar.pg test-out/gen

# Compare outputs
diff -r test-out/hand test-out/gen
```

## Files in This Directory

### Generated by RTK
- `GrammarLexer.x` - Lexer specification for RTK grammar
- `GrammarParser.y` - Parser specification for RTK grammar
- `GrammarQQ.hs` - QuasiQuoter for RTK grammar manipulation

### Compiled by Alex/Happy
- `GrammarLexer.hs` - Haskell lexer module (generated from .x)
- `GrammarParser.hs` - Haskell parser module (generated from .y)

### Hand-Written
- `ASTAdapter.hs` - Converts generated AST to hand-written AST format
- `README.md` - This file

## AST Conversion

The generated parser produces an AST with auto-generated types. `ASTAdapter.hs` converts this to the hand-written `InitialGrammar` type used by the rest of RTK.

### Approach: QuasiQuotation (Dogfooding!)

We use **RTK's own quasi-quotation features** to pattern match on the generated AST. This demonstrates RTK using its own capabilities.

```haskell
{-# LANGUAGE QuasiQuotes #-}
import qualified GrammarQQ as QQ

-- Pattern match using quasi-quotation - reads like the grammar!
convertGrammar :: Gen.Grammar -> Hand.InitialGrammar
convertGrammar [QQ.grammar| grammar $name ';' $imports $rules |] =
    Hand.InitialGrammar
        { getIGrammarName = name
        , getImports = imports
        , getIRules = map convertRule rules
        }

-- Convert rules with declarative patterns
convertRule [QQ.rule| $name = $clause ; |] =
    Hand.IRule { getRuleName = name, ... }

convertRule [QQ.rule| $type : $name = $clause ; |] =
    Hand.IRule { getDataTypeName = Just type, ... }
```

### Benefits

1. **Dogfooding**: RTK uses its own features to parse its own grammar
2. **Declarative**: Patterns read like grammar rules
3. **Self-Documenting**: The code shows the grammar structure clearly
4. **Maintainable**: Changes to grammar.pg automatically reflected

### Fallback Approaches

If quasi-quotation pattern matching isn't fully supported, `ASTAdapter.hs` includes:
- **Approach 2**: Hybrid QQ + traditional pattern matching
- **Approach 3**: String-based QQ validation
- **Fallback**: Traditional constructor pattern matching

## Troubleshooting

### Error: "module GrammarLexer not found"
- Make sure you ran Step 2 to compile the .x file
- Check that `GrammarLexer.hs` exists in this directory

### Error: "parse error in generated code"
- Regenerate files from Step 1
- Check that `grammar.pg` is valid

### Error: "type mismatch in adapter"
- Regenerate files - AST structure may have changed
- Update `ASTAdapter.hs` to match new generated types

## Development Workflow

When changing `test-grammars/grammar.pg`:

1. Regenerate files: `rtk test-grammars/grammar.pg src/generated/`
2. Recompile: `alex GrammarLexer.x` and `happy GrammarParser.y`
3. Update `ASTAdapter.hs` if AST changed
4. Rebuild: `cabal build`
5. Test: `rtk --use-generated ...`

## Status

Part of Prototype 2: Close the Loop
- See `docs/self-hosting-strategy.md` for full roadmap
- See `docs/prototype-2-plan.md` for implementation details
