name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build, Lint, and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.4'
        cabal-version: '3.10.2.0'
        enable-stack: false
      env:
        GHCUP_INSTALL_BASE_PREFIX: ${{ runner.temp }}/ghcup

    - name: Cache Cabal packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project', 'cabal.project.freeze') }}
        restore-keys: |
          ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project') }}
          ${{ runner.os }}-cabal-

    - name: Cache test outputs
      id: cache-test-out
      uses: actions/cache@v4
      with:
        path: test-out
        key: v2-${{ runner.os }}-test-out-${{ hashFiles('test-grammars/**', 'Normalize.hs', 'CodeGen.hs', '*.x', '*.y', 'makefile') }}
        restore-keys: |
          v2-${{ runner.os }}-test-out-

    - name: Update timestamps on cached test outputs
      run: |
        # Update timestamps to prevent Make from thinking files are out of date
        if [ -d test-out ]; then
          echo "Updating timestamps on cached test-out files..."
          find test-out -type f -exec touch {} +
        fi

    - name: Update Cabal package list
      run: cabal update

    - name: Install build tools (Alex and Happy)
      run: cabal install alex happy --installdir=$HOME/.cabal/bin --overwrite-policy=always --install-method=copy

    - name: Build project with linting (treat warnings as errors)
      run: |
        export PATH="$HOME/.cabal/bin:$PATH"
        # Build with -Werror to treat all warnings as errors
        # This will fail the build if there are any unused imports or other warnings
        cabal build --ghc-options="-Werror" --enable-tests --enable-benchmarks -j

    - name: Run all tests
      run: |
        export PATH="$HOME/.cabal/bin:$PATH"

        # Create results file
        results_file="test-results.txt"
        > "$results_file"

        # Function to run a test and capture result
        run_test() {
          local test_name="$1"
          local test_command="$2"

          echo ""
          echo "=========================================="
          echo "Running: $test_name"
          echo "=========================================="

          if eval "$test_command"; then
            echo "$test_name|PASS" >> "$results_file"
            echo "✓ $test_name: PASSED"
          else
            echo "$test_name|FAIL" >> "$results_file"
            echo "✗ $test_name: FAILED"
          fi
        }

        # Run all tests (continue even if some fail)
        run_test "Basic Unit Tests" "make test"
        run_test "Base Grammar Test" "make test-grammar"
        run_test "Java Test Suite" "make test-all-java"
        run_test "Java QQ Tests" "make test-java-qq"
        run_test "Debug Options Test" "make test-debug"
        run_test "Comprehensive Debug Test" "make test-debug-all"
        run_test "Automated Debug Options" "make test-debug-options"

    - name: Print test results summary
      if: always()
      run: |
        results_file="test-results.txt"

        echo ""
        echo "=========================================="
        echo "           TEST RESULTS SUMMARY"
        echo "=========================================="
        echo ""
        printf "%-30s | %s\n" "TEST NAME" "RESULT"
        printf "%-30s-+--------\n" "------------------------------"

        # Track if any test failed
        any_failed=0

        while IFS='|' read -r test_name result; do
          if [ "$result" = "PASS" ]; then
            printf "%-30s | ✓ %s\n" "$test_name" "$result"
          else
            printf "%-30s | ✗ %s\n" "$test_name" "$result"
            any_failed=1
          fi
        done < "$results_file"

        echo ""
        echo "=========================================="

        # Exit with failure if any test failed
        if [ $any_failed -eq 1 ]; then
          echo "❌ One or more tests failed!"
          exit 1
        else
          echo "✅ All tests passed!"
          exit 0
        fi

    - name: Bootstrap comparison test (informational)
      continue-on-error: true
      run: |
        export PATH="$HOME/.cabal/bin:$PATH"
        echo ""
        echo "==========================================="
        echo "Bootstrap Self-Hosting Comparison"
        echo "==========================================="
        echo "This test compares hand-written Lexer.x and Parser.y"
        echo "with generated files from test-grammars/grammar.pg"
        echo "to track progress toward RTK self-hosting."
        echo ""
        make test-bootstrap

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-output
        path: |
          test-out/
          happy_log.txt
        if-no-files-found: ignore
